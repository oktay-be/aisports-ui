name: Deploy UI to Cloud Run

# Required GitHub Actions Variables:
# - VITE_GOOGLE_CLIENT_ID: Google OAuth Client ID
# - VITE_HISTORICAL_FETCH_DEPTH: Number of days of historical data to prefetch on login (default: 3)
# - VITE_GCS_API_URL (secret): GCS API function URL
# - VITE_GCS_API_KEY (secret): API key for GCS API function
#
# Infrastructure variables:
# - GCP_PROJECT_NUMBER, GCP_SERVICE_ACCOUNT, WIF_POOL_ID, WIF_PROVIDER_ID, REGION
#
# Note: server.js is now a minimal static file server. All API calls go to gcs_api_function.

on:
  push:
    branches:
      - main
      - dev
    paths:
      - '**/*.tsx'
      - '**/*.ts'
      - '**/*.js'
      - 'components/**'
      - 'services/**'
      - 'package.json'
      - 'vite.config.ts'
      - 'server.js'
      - '.github/workflows/**'

  workflow_dispatch:

permissions:
  id-token: write # This is crucial for Workload Identity Federation
  contents: read # Allow checkout action to read the repository

jobs:
  # Calculate version using GitVersion
  version:
    uses: ./.github/workflows/gitversion.yml

  deploy:
    needs: version
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install Dependencies
      run: npm install

    - name: Syntax Check Server
      run: node --check server.js

    - name: Build React Application
      run: npm run build
      env:
        VITE_GOOGLE_CLIENT_ID: ${{ vars.VITE_GOOGLE_CLIENT_ID }}
        VITE_HISTORICAL_FETCH_DEPTH: ${{ vars.VITE_HISTORICAL_FETCH_DEPTH }}
        VITE_GCS_API_URL: ${{ secrets.VITE_GCS_API_URL }}
        VITE_GCS_API_KEY: ${{ secrets.VITE_GCS_API_KEY }}

    - name: Authenticate to Google Cloud (Workload Identity Federation)
      uses: google-github-actions/auth@v2
      with:
        workload_identity_provider: 'projects/${{ vars.GCP_PROJECT_NUMBER }}/locations/global/workloadIdentityPools/${{ vars.WIF_POOL_ID }}/providers/${{ vars.WIF_PROVIDER_ID }}'
        service_account: ${{ vars.GCP_SERVICE_ACCOUNT }}
        export_environment_variables: true

    - name: Deploy to Cloud Run
      uses: google-github-actions/deploy-cloudrun@v2
      with:
        service: aisports-ui
        region: ${{ vars.REGION }}
        source: .
        env_vars: |
          NODE_ENV=production
          APP_VERSION=${{ needs.version.outputs.semVer }}
        flags: |
          --allow-unauthenticated
          --service-account=${{ vars.GCP_SERVICE_ACCOUNT }}
          --memory=256Mi
          --cpu=1
          --timeout=60
          --min-instances=0
          --max-instances=10
          --set-build-env-vars=GOOGLE_NODE_RUN_SCRIPTS=

    - name: Deployment Summary
      run: |
        echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| Service | aisports-ui |" >> $GITHUB_STEP_SUMMARY
        echo "| Version | ${{ needs.version.outputs.semVer }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Branch | ${{ github.ref_name }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Region | ${{ vars.REGION }} |" >> $GITHUB_STEP_SUMMARY
