# =============================================================================
# GitVersion - Reusable Workflow
# =============================================================================
# Calculates semantic version based on git history and GitVersion.yml config.
# Called by deployment workflows to get version for APP_VERSION env var.
#
# USAGE:
#   jobs:
#     version:
#       uses: ./.github/workflows/gitversion.yml
#
#     deploy:
#       needs: version
#       steps:
#         - run: echo "Version: ${{ needs.version.outputs.semVer }}"
# =============================================================================

name: GitVersion

on:
  workflow_call:
    outputs:
      semVer:
        description: 'Full semantic version (e.g., 1.2.0-beta.3)'
        value: ${{ jobs.version.outputs.semVer }}
      majorMinorPatch:
        description: 'Major.Minor.Patch only (e.g., 1.2.0)'
        value: ${{ jobs.version.outputs.majorMinorPatch }}
      preReleaseTag:
        description: 'Pre-release tag (e.g., beta.3)'
        value: ${{ jobs.version.outputs.preReleaseTag }}
      fullSemVer:
        description: 'Full semantic version with metadata'
        value: ${{ jobs.version.outputs.fullSemVer }}

jobs:
  version:
    runs-on: ubuntu-latest
    outputs:
      semVer: ${{ steps.gitversion.outputs.semVer }}
      majorMinorPatch: ${{ steps.gitversion.outputs.majorMinorPatch }}
      preReleaseTag: ${{ steps.gitversion.outputs.preReleaseTag }}
      fullSemVer: ${{ steps.gitversion.outputs.fullSemVer }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Required for GitVersion to analyze full history

      - name: Install GitVersion
        uses: gittools/actions/gitversion/setup@v3.0.0
        with:
          versionSpec: '6.x'

      - name: Determine Version
        id: gitversion
        uses: gittools/actions/gitversion/execute@v3.0.0
        with:
          useConfigFile: true
          configFilePath: GitVersion.yml

      - name: Display Version
        run: |
          echo "## GitVersion Output" >> $GITHUB_STEP_SUMMARY
          echo "| Variable | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| SemVer | ${{ steps.gitversion.outputs.semVer }} |" >> $GITHUB_STEP_SUMMARY
          echo "| MajorMinorPatch | ${{ steps.gitversion.outputs.majorMinorPatch }} |" >> $GITHUB_STEP_SUMMARY
          echo "| PreReleaseTag | ${{ steps.gitversion.outputs.preReleaseTag }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Branch | ${{ github.ref_name }} |" >> $GITHUB_STEP_SUMMARY
